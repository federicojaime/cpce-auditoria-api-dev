

# üì¶ DOCUMENTACI√ìN COMPLETA: Sistema de Compras de Alto Costo

## Fecha: 2025-10-22

---

## üéØ ARQUITECTURA COMPLETA DEL SISTEMA

### Flujo de Negocio (De principio a fin)

```
1. AUDITOR√çA
   ‚îú‚îÄ Auditor revisa recetas de alto costo
   ‚îú‚îÄ Aprueba medicamentos (estado 1 ‚Üí "Autorizado")
   ‚îî‚îÄ Selecciona auditor√≠as para solicitar presupuesto

2. SOLICITUD DE PRESUPUESTO
   ‚îú‚îÄ Se crea lote con m√∫ltiples auditor√≠as
   ‚îú‚îÄ Se env√≠an emails a proveedores seleccionados
   ‚îú‚îÄ Cada proveedor recibe un token √∫nico
   ‚îî‚îÄ Medicamentos cambian estado 1 ‚Üí 4 ("En presupuesto")

3. RESPUESTA DE PROVEEDORES
   ‚îú‚îÄ Proveedores responden por email (link con token)
   ‚îú‚îÄ Por cada medicamento: acepta/rechaza + precio + fechas + lugar retiro
   ‚îú‚îÄ Se notifica a administradores por email
   ‚îî‚îÄ Estado de solicitud: ENVIADO ‚Üí PARCIAL ‚Üí COMPLETADO

4. COMPARACI√ìN Y ADJUDICACI√ìN
   ‚îú‚îÄ Auditor compara presupuestos de todos los proveedores
   ‚îú‚îÄ Sistema identifica mejor precio autom√°ticamente
   ‚îú‚îÄ Auditor elige ganador y adjudica
   ‚îî‚îÄ Se crea ORDEN DE COMPRA

5. ORDEN DE COMPRA Y ENTREGA
   ‚îú‚îÄ Se crea registro en rec_compras_alto_costo (cabecera)
   ‚îú‚îÄ Se crea detalle en rec_compras_alto_costo_detalle (medicamentos)
   ‚îú‚îÄ Medicamentos cambian estado 4 ‚Üí 5 ("En compra")
   ‚îú‚îÄ Proveedor ganador marcado como ADJUDICADO
   ‚îú‚îÄ Seguimiento de entrega con estados
   ‚îî‚îÄ Notificaci√≥n al paciente (futuro)
```

---

## üóÑÔ∏è ESTRUCTURA DE BASE DE DATOS

### Tabla Principal: `rec_compras_alto_costo`

**Prop√≥sito:** Representa UNA orden de compra para UNA auditor√≠a espec√≠fica

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | int(11) PK | ID √∫nico de la orden |
| `idreceta` | int(11) FK | Auditor√≠a asociada (rec_receta_alto_costo.idreceta) |
| **`id_proveedor`** | **int(11) FK** | **Proveedor adjudicado (alt_proveedor.id_proveedor)** |
| **`id_solicitud_presupuesto`** | **int(11) FK** | **Solicitud de presupuesto original** |
| **`monto_total`** | **decimal(15,2)** | **Monto total de la orden** |
| `estado_compra` | enum | Estado actual (adjudicado, confirmado, en_preparacion, listo_retiro, entregado, finalizado, cancelado) |
| `fecha_recepcion` | datetime | Fecha de creaci√≥n de la orden |
| `fecha_envio_proveedores` | datetime | (legacy - no usado en nuevo flujo) |
| **`fecha_estimada_entrega`** | **datetime** | **Fecha estimada de entrega del proveedor** |
| **`fecha_entrega_real`** | **datetime** | **Fecha real en que se entreg√≥** |
| **`lugar_retiro`** | **varchar(255)** | **Direcci√≥n donde se retira** |
| `id_usuario_compras` | int(11) | Usuario de compras (opcional) |
| **`usuario_adjudico`** | **int(11)** | **Usuario que adjudic√≥ el presupuesto** |
| `observaciones` | text | Observaciones de la orden |

**√çndices:**
- `idx_proveedor`: Buscar por proveedor
- `idx_solicitud`: Buscar por solicitud de presupuesto
- `idx_estado`: Filtrar por estado
- `idx_fecha_entrega`: Ordenar por fecha de entrega

**Foreign Keys:**
- `fk_compra_proveedor`: id_proveedor ‚Üí alt_proveedor.id_proveedor
- `fk_compra_solicitud`: id_solicitud_presupuesto ‚Üí alt_solicitud_presupuesto.id_solicitud
- `fk_compra_receta`: idreceta ‚Üí rec_receta_alto_costo.idreceta

---

### Tabla de Detalle: `rec_compras_alto_costo_detalle`

**Prop√≥sito:** Detalle de medicamentos por orden de compra (uno a muchos)

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | int(11) PK | ID √∫nico del detalle |
| `id_compra` | int(11) FK | Orden de compra (rec_compras_alto_costo.id) |
| `id_medicamento` | int(11) | ID del medicamento |
| `codigo_medicamento` | varchar(50) | C√≥digo del vadem√©cum |
| `nombre_medicamento` | varchar(255) | Nombre comercial (snapshot) |
| `presentacion` | varchar(255) | Presentaci√≥n (snapshot) |
| `cantidad` | int(11) | Cantidad solicitada |
| `precio_unitario` | decimal(10,2) | Precio unitario adjudicado |
| `precio_total` | decimal(10,2) | Precio total (cantidad √ó precio_unitario) |
| `fecha_vencimiento` | date | Fecha de vencimiento del medicamento |
| `lote_medicamento` | varchar(100) | N√∫mero de lote entregado |
| `observaciones` | text | Observaciones del medicamento |
| `fecha_creacion` | datetime | Fecha de creaci√≥n del registro |

**√çndices:**
- `idx_compra`: Buscar detalles por orden
- `idx_medicamento`: Buscar por medicamento

**Foreign Keys:**
- `fk_detalle_compra`: id_compra ‚Üí rec_compras_alto_costo.id (ON DELETE CASCADE)

---

## üîÑ ESTADOS DE LA ORDEN DE COMPRA

| Estado | Descripci√≥n | Qui√©n lo cambia |
|--------|-------------|-----------------|
| `adjudicado` | Presupuesto adjudicado, esperando confirmaci√≥n del proveedor | Sistema (autom√°tico al adjudicar) |
| `confirmado` | Proveedor confirm√≥ que puede entregar | Proveedor o Admin |
| `en_preparacion` | Proveedor est√° preparando el pedido | Proveedor o Admin |
| `listo_retiro` | Pedido listo para retirar | Proveedor o Admin |
| `entregado` | Medicamentos fueron entregados/retirados | Admin (al confirmar retiro) |
| `finalizado` | Proceso completado, todo documentado | Admin |
| `cancelado` | Orden cancelada | Admin |

---

## üîå API: Endpoint de Adjudicaci√≥n

### POST `/api/presupuestos/solicitudes-email/:id/adjudicar`

**Prop√≥sito:** Adjudicar un presupuesto al proveedor ganador y crear √≥rdenes de compra

#### Request

```json
{
  "proveedorId": 2,
  "observaciones": "Mejor precio y tiempo de entrega"
}
```

#### Proceso (paso a paso)

1. **Validar solicitud existe y est√° en estado v√°lido**
2. **Verificar que el proveedor respondi√≥ a la solicitud**
3. **Obtener todos los medicamentos aceptados por el proveedor**
4. **Para cada auditor√≠a de la solicitud:**
   - Obtener datos del paciente
   - Calcular monto total
   - **Crear orden de compra** en `rec_compras_alto_costo`:
     - Con proveedor ganador
     - Monto total
     - Fecha estimada de entrega
     - Lugar de retiro
     - Usuario que adjudic√≥
     - Estado inicial: `'adjudicado'`
   - **Crear detalles** en `rec_compras_alto_costo_detalle`:
     - Por cada medicamento con precio, cantidad, totales
     - Snapshot de nombre y presentaci√≥n
   - **Actualizar medicamentos:** estado 4 ‚Üí 5 ("En compra")
5. **Actualizar estado de solicitud de presupuesto:** ‚Üí `'ADJUDICADO'`
6. **Marcar proveedor ganador como adjudicado**
7. **Commit de transacci√≥n**

#### Response (Success)

```json
{
  "mensaje": "Presupuesto adjudicado exitosamente",
  "ordenesCreadas": [
    {
      "ordenId": 123,
      "auditoriaId": 17,
      "paciente": "Jaime, Federico",
      "monto": 1231211,
      "medicamentos": 1,
      "lugarRetiro": "Sucursal Centro - Av. San Mart√≠n 456"
    },
    {
      "ordenId": 124,
      "auditoriaId": 18,
      "paciente": "P√©rez, Juan",
      "monto": 5000.50,
      "medicamentos": 2,
      "lugarRetiro": "Sucursal Centro - Av. San Mart√≠n 456"
    }
  ],
  "proveedorAdjudicado": {
    "id": 2,
    "nombre": "Droguer√≠a Alta luna S.R.L.s"
  }
}
```

#### C√≥digo Clave

```javascript
// Crear orden de compra (cabecera)
await connection.query(
    `INSERT INTO rec_compras_alto_costo
    (idreceta, id_proveedor, id_solicitud_presupuesto, monto_total,
     estado_compra, fecha_estimada_entrega, lugar_retiro, observaciones, usuario_adjudico)
    VALUES (?, ?, ?, ?, 'adjudicado', ?, ?, ?, ?)`,
    [auditoriaId, proveedorId, solicitudId, montoTotal, fechaEntrega, lugar, obs, userId]
);

// Insertar detalle (por cada medicamento)
await connection.query(
    `INSERT INTO rec_compras_alto_costo_detalle
    (id_compra, id_medicamento, codigo_medicamento, nombre_medicamento,
     presentacion, cantidad, precio_unitario, precio_total, fecha_vencimiento, observaciones)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
    [ordenId, medId, codigo, nombre, present, cant, precioUnit, precioTot, venc, obs]
);
```

---

## üìß NOTIFICACIONES POR EMAIL

### Email de Administradores

**Cu√°ndo:** Cuando un proveedor responde a una solicitud de presupuesto

**Destinatarios:** Todos los usuarios con `rol = 1` (administradores) que tengan `email` configurado

**Query:**
```sql
SELECT email FROM user_au
WHERE rol = 1
AND email IS NOT NULL
AND email != ''
```

**Contenido del Email:**
```
Asunto: üîî Nueva Respuesta de Presupuesto - [Proveedor]

Se ha recibido una respuesta de presupuesto

Proveedor: Droguer√≠a del Sud S.R.Ls
Lote: LOTE-20251022-1142
Auditor√≠a: #18

Resumen: 2 medicamento(s) aceptado(s), 0 rechazado(s)

Por favor, ingrese al sistema para revisar los detalles completos.
```

**IMPORTANTE:** Si ning√∫n admin tiene email configurado, el sistema registra un warning pero NO falla:
```
‚ö†Ô∏è No hay administradores con email configurado para notificar
```

---

## üìä QUERIES √öTILES

### Ver todas las √≥rdenes de compra con sus proveedores

```sql
SELECT
    c.id as orden_id,
    c.idreceta as auditoria_id,
    p.razon_social as proveedor,
    c.monto_total,
    c.estado_compra,
    c.fecha_estimada_entrega,
    c.lugar_retiro,
    COUNT(d.id) as cantidad_medicamentos
FROM rec_compras_alto_costo c
INNER JOIN alt_proveedor p ON c.id_proveedor = p.id_proveedor
LEFT JOIN rec_compras_alto_costo_detalle d ON c.id = d.id_compra
GROUP BY c.id
ORDER BY c.fecha_recepcion DESC;
```

### Ver detalle completo de una orden

```sql
SELECT
    c.id as orden_id,
    c.estado_compra,
    c.monto_total,
    c.lugar_retiro,
    p.razon_social as proveedor,
    d.nombre_medicamento,
    d.presentacion,
    d.cantidad,
    d.precio_unitario,
    d.precio_total,
    d.fecha_vencimiento
FROM rec_compras_alto_costo c
INNER JOIN alt_proveedor p ON c.id_proveedor = p.id_proveedor
INNER JOIN rec_compras_alto_costo_detalle d ON c.id = d.id_compra
WHERE c.id = 123;
```

### Ver √≥rdenes pendientes de entrega

```sql
SELECT
    c.id,
    c.idreceta,
    p.razon_social as proveedor,
    c.estado_compra,
    c.fecha_estimada_entrega,
    c.lugar_retiro,
    CONCAT(pa.apellido, ', ', pa.nombre) as paciente
FROM rec_compras_alto_costo c
INNER JOIN alt_proveedor p ON c.id_proveedor = p.id_proveedor
INNER JOIN rec_receta_alto_costo r ON c.idreceta = r.idreceta
INNER JOIN rec_paciente pa ON r.idpaciente = pa.id
WHERE c.estado_compra IN ('adjudicado', 'confirmado', 'en_preparacion', 'listo_retiro')
ORDER BY c.fecha_estimada_entrega ASC;
```

---

## üöÄ PASOS DE IMPLEMENTACI√ìN

### 1. Aplicar Migraci√≥n SQL

```bash
# IMPORTANTE: Hacer backup primero
mysqldump -u usuario -p base_datos > backup_antes_migracion_$(date +%Y%m%d_%H%M%S).sql

# Aplicar migraci√≥n
mysql -u usuario -p base_datos < migrations/fix_compras_alto_costo_estructura_completa.sql
```

### 2. Configurar Emails de Administradores

```sql
-- Ver administradores actuales
SELECT id, nombre, apellido, user, rol, email FROM user_au WHERE rol = 1;

-- Configurar emails
UPDATE user_au SET email = 'admin@tuempresa.com' WHERE id = 1;
UPDATE user_au SET email = 'supervisor@tuempresa.com' WHERE id = 2;

-- Verificar
SELECT id, nombre, apellido, email FROM user_au WHERE rol = 1 AND email IS NOT NULL;
```

### 3. Reiniciar Servidor Node.js

```bash
# Detener servidor (Ctrl+C en la terminal)
# O si usas PM2:
pm2 restart api

# O simplemente:
npm restart
```

### 4. Verificar Todo Funciona

1. **Crear solicitud de presupuesto** ‚Üí Debe enviar emails a proveedores
2. **Proveedor responde** ‚Üí Debe notificar a administradores
3. **Adjudicar presupuesto** ‚Üí Debe crear orden con detalle
4. **Verificar en base de datos:**

```sql
-- Ver orden creada
SELECT * FROM rec_compras_alto_costo ORDER BY id DESC LIMIT 1;

-- Ver detalle de la orden
SELECT * FROM rec_compras_alto_costo_detalle WHERE id_compra = [ID_DE_ARRIBA];
```

---

## ‚ö†Ô∏è PROBLEMAS COMUNES

### Error: "Unknown column 'id_proveedor'"

**Causa:** No aplicaste la migraci√≥n SQL

**Soluci√≥n:**
```bash
mysql -u usuario -p base_datos < migrations/fix_compras_alto_costo_estructura_completa.sql
```

### Error: "No recipients defined" en email

**Causa:** Ning√∫n administrador tiene email configurado

**Soluci√≥n:**
```sql
UPDATE user_au SET email = 'tu_email@ejemplo.com' WHERE rol = 1 AND id = TU_ID;
```

### Warning: "No hay administradores con email configurado"

**Causa:** El servidor tiene c√≥digo viejo en memoria

**Soluci√≥n:** Reiniciar el servidor Node.js

### Error: "Table 'rec_compras_alto_costo_detalle' doesn't exist"

**Causa:** La migraci√≥n SQL fall√≥ o no se complet√≥

**Soluci√≥n:** Revisar errores en la migraci√≥n y volver a ejecutarla

---

## üìà REPORTES Y ANAL√çTICAS (Futuro)

### Endpoints a Implementar

```
GET /api/compras/estadisticas
- Total de √≥rdenes
- Monto total comprado
- Distribuci√≥n por proveedor
- Distribuci√≥n por estado
- Ahorro vs precio vadem√©cum

GET /api/compras/ordenes
- Listar √≥rdenes con filtros (estado, fecha, proveedor)
- Paginaci√≥n

GET /api/compras/ordenes/:id
- Detalle completo de una orden
- Con medicamentos, proveedor, auditor√≠a, paciente

PUT /api/compras/ordenes/:id/estado
- Actualizar estado de una orden
- Notificar al paciente cuando estado = 'listo_retiro'

GET /api/compras/proveedores/ranking
- Ranking de proveedores por monto
- Por cantidad de √≥rdenes
- Por cumplimiento de tiempos
```

---

## ‚úÖ CHECKLIST DE IMPLEMENTACI√ìN

- [x] Crear migraci√≥n SQL para rec_compras_alto_costo
- [x] Crear tabla rec_compras_alto_costo_detalle
- [x] Actualizar c√≥digo de adjudicaci√≥n
- [x] Agregar campo email a user_au
- [x] Actualizar notificaciones por email
- [ ] Aplicar migraciones en base de datos
- [ ] Configurar emails de administradores
- [ ] Reiniciar servidor
- [ ] Probar flujo completo
- [ ] Implementar endpoints de reportes (futuro)
- [ ] Implementar notificaci√≥n a pacientes (futuro)

---

## üìû SOPORTE

Para dudas o problemas con la implementaci√≥n, contactar al equipo de desarrollo.

**Archivos relacionados:**
- `/migrations/fix_compras_alto_costo_estructura_completa.sql`
- `/migrations/add_email_user_au.sql`
- `/migrations/add_lugar_retiro.sql`
- `/controllers/presupuestoTokenController.js`
- `/DOCUMENTACION_EMAIL_ADMINS.md`
- `/DOCUMENTACION_LUGAR_RETIRO.md`
- `/DOCUMENTACION_ADJUDICACION_ORDENES.md`
